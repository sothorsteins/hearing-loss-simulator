<!DOCTYPE html>
<html>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
 
<head>
  <title>Host that loads a plugin with its GUI</title>
  <script
    src="https://mainline.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js">
  </script>
  <script src="hearingLossSim.js"></script>
</head>
<body>
    <audio src="./trainconversation.wav" id="soundSample" controls loop></audio>
    <button id="save">Save current state</button>
    <button id="load">Load last saved state</button>
    <p>
        Noise volume:</p>
        <input type="range" oninput="changeVolume(event) " min="0" max="1" value="0.5" step="0.01" />
</body>
<script>
    
    

    var isWebKitAudio = (typeof (webkitAudioContext) !== "undefined");
    var ctx = (isWebKitAudio) ? new webkitAudioContext() : new AudioContext();
    var noise_dsp = null;

    var player = document.getElementById("soundSample");
    player.onplay = () => {
        ctx.resume().then(() => {
            console.log('Playback resumed successfully');
        });
    }

    // Slider handler to change the 'noise' volume
    function changeVolume(event) {
        noise_dsp.setParamValue("/Noise/Volume", parseFloat(event.target.value));
    }

    function startnoise() {
        // Create the Faust generated node
        var pluginURL = ".";
        var plugin = new FausthearingLossSim(ctx, pluginURL);
        plugin.load().then(node => {
            noise_dsp = node;
            console.log(noise_dsp.getJSON());
            // Print path to be used with 'setParamValue'
            console.log(noise_dsp.getParams());
            // Connect it to output as a regular WebAudio node
            noise_dsp.connect(audio_context.destination);
        });
    }

    var mediaSource = ctx.createMediaElementSource(player);
    var pluginURL = ".";
    var plugin = new FausthearingLossSim(ctx, pluginURL);
    /*
    plugin.load().then((node) => {
    plugin.loadGui().then((elem) => {
      document.body.appendChild(elem);
      document.querySelector("#save").addEventListener('click', () => {
        node.getState()
          .then((data) => {
            state = data;
            console.log("State saved :", data);
          })
      });
      document.querySelector("#load").addEventListener('click', () => {
        node.setState(state).then((data) => {
          console.log("State restored :", data)
        })
      });
    });
    console.log(node.getDescriptor());
    mediaSource.connect(node);
    node.connect(ctx.destination);
    });
    */
    window.addEventListener("load", startnoise);
    
</script>

</html>
